<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exch Index</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <script>
    (function(){
        var s = localStorage.getItem('exchAppearance');
        var prefersDark = window.matchMedia('(prefers-color-scheme:dark)').matches;
        if (s === 'light' || (!s && !prefersDark)) {
            document.documentElement.classList.add('light');
        }
    })();
    </script>
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        :root {
            color-scheme: dark;
            --glass-bg: rgba(255, 255, 255, 0.06);
            --glass-bg-heavy: rgba(255, 255, 255, 0.10);
            --glass-bg-light: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-highlight: rgba(255, 255, 255, 0.05);
            --glass-blur: blur(20px) saturate(180%);
            --glass-blur-heavy: blur(40px) saturate(190%);
            --dark-surface: rgba(44, 44, 46, 0.92);
            --radius-sm: 10px;
            --radius-md: 16px;
            --radius-lg: 24px;
            --radius-pill: 50px;
            --text-primary: rgba(255, 255, 255, 0.92);
            --text-secondary: rgba(255, 255, 255, 0.70);
            --text-tertiary: rgba(255, 255, 255, 0.45);
            --text-quaternary: rgba(255, 255, 255, 0.25);
            --accent-blue: #007AFF;
            --accent-indigo: #5856D6;
            --accent-teal: #5AC8FA;
            --accent-green: #34C759;
            --accent-orange: #FF9500;
            --accent-red: #FF3B30;
            --accent-pink: #FF2D55;
            --accent-purple: #AF52DE;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.20);
            --shadow-md: 0 2px 8px rgba(0, 0, 0, 0.25);
            --shadow-lg: 0 4px 16px rgba(0, 0, 0, 0.30);
            --shadow-glow: 0 0 0 4px rgba(0, 122, 255, 0.35);
            --font-display: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', sans-serif;
            --font-body: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Helvetica Neue', sans-serif;
            --font-mono: 'SF Mono', 'JetBrains Mono', 'Menlo', monospace;
        }

        body {
            font-family: var(--font-body);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            background: #1c1c1e;
            background-image:
                radial-gradient(ellipse 80% 60% at 20% 10%, rgba(175, 82, 222, 0.04), transparent 60%),
                radial-gradient(ellipse 70% 50% at 80% 20%, rgba(90, 200, 250, 0.03), transparent 60%),
                radial-gradient(ellipse 60% 50% at 50% 80%, rgba(255, 149, 0, 0.02), transparent 60%),
                radial-gradient(ellipse 90% 70% at 60% 40%, rgba(0, 122, 255, 0.03), transparent 70%);
            background-attachment: fixed;
        }

        /* --- Scrollbar --- */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.02); }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.15); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.30); }

        /* --- Animations --- */
        @keyframes fade-up {
            from { opacity: 0; transform: translateY(12px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .animate-fade-up {
            opacity: 0;
            animation: fade-up 0.4s ease forwards;
        }

        /* --- Glass shared --- */
        .glass-panel {
            background: var(--glass-bg);
            -webkit-backdrop-filter: var(--glass-blur);
            backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm), inset 0 1px 0 var(--glass-highlight);
        }

        /* --- Layout --- */
        .app-container {
            position: relative;
            z-index: 1;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 24px;
        }

        /* --- Header --- */
        .header-bar {
            position: sticky;
            top: 0;
            z-index: 40;
            background: rgba(28, 28, 30, 0.85);
            -webkit-backdrop-filter: var(--glass-blur-heavy);
            backdrop-filter: var(--glass-blur-heavy);
            border-bottom: 1px solid var(--glass-border);
            padding: 14px 0;
        }

        .header-inner {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            flex-wrap: wrap;
        }

        .logo-block h1 {
            font-family: var(--font-display);
            font-size: 1.35rem;
            font-weight: 700;
            letter-spacing: -0.01em;
            color: var(--text-primary);
        }
        .logo-block h1 span {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-indigo));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .logo-block .subtitle {
            font-family: var(--font-body);
            font-size: 0.72rem;
            color: var(--text-tertiary);
            letter-spacing: 0.01em;
            margin-top: 1px;
            font-weight: 500;
        }

        /* --- Stats --- */
        .stats-row {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .stat-block {
            text-align: center;
        }
        .stat-block .stat-value {
            font-family: var(--font-display);
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--accent-blue);
        }
        .stat-block .stat-label {
            font-size: 0.6rem;
            font-weight: 600;
            letter-spacing: 0.04em;
            text-transform: uppercase;
            color: var(--text-tertiary);
        }
        .stat-divider {
            width: 1px;
            height: 28px;
            background: var(--glass-border);
        }

        .icon-btn {
            padding: 8px;
            border: 1px solid var(--glass-border);
            background: var(--glass-bg-light);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: var(--radius-sm);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
        }
        .icon-btn:hover {
            color: var(--accent-blue);
            background: rgba(0, 122, 255, 0.08);
            border-color: rgba(0, 122, 255, 0.2);
        }
        .icon-btn svg { width: 16px; height: 16px; }

        /* --- Filter bar --- */
        .filter-bar {
            position: sticky;
            top: 56px;
            z-index: 39;
            background: var(--glass-bg);
            -webkit-backdrop-filter: var(--glass-blur-heavy);
            backdrop-filter: var(--glass-blur-heavy);
            padding: 12px 0;
        }
        .filter-bar > .app-container {
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 12px 24px;
            box-shadow: inset 0 1px 0 var(--glass-highlight);
        }

        .filter-row {
            display: flex;
            gap: 8px;
            flex-wrap: nowrap;
            align-items: center;
        }

        .glass-input {
            flex: 1;
            min-width: 120px;
            padding: 9px 12px 9px 36px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
            font-family: var(--font-body);
            font-size: 0.88rem;
            font-weight: 400;
            outline: none;
            transition: all 0.2s ease;
            border-radius: var(--radius-pill);
            -webkit-backdrop-filter: blur(12px) saturate(150%);
            backdrop-filter: blur(12px) saturate(150%);
            box-shadow: inset 0 1px 0 var(--glass-highlight), var(--shadow-sm);
        }
        .glass-input::placeholder { color: var(--text-quaternary); }
        .glass-input:focus {
            border-color: var(--accent-blue);
            box-shadow: var(--shadow-glow), inset 0 1px 0 var(--glass-highlight);
            background: var(--glass-bg-heavy);
        }

        .search-wrap {
            position: relative;
            flex: 1.5;
            min-width: 100px;
        }
        .search-wrap svg {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 15px;
            height: 15px;
            color: var(--text-quaternary);
            pointer-events: none;
        }

        .glass-select {
            padding: 9px 30px 9px 12px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-secondary);
            font-family: var(--font-body);
            font-size: 0.85rem;
            font-weight: 500;
            outline: none;
            cursor: pointer;
            transition: all 0.2s ease;
            appearance: none;
            border-radius: var(--radius-pill);
            -webkit-backdrop-filter: blur(12px) saturate(150%);
            backdrop-filter: blur(12px) saturate(150%);
            box-shadow: inset 0 1px 0 var(--glass-highlight), var(--shadow-sm);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' viewBox='0 0 10 6'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%238892b0' fill='none' stroke-width='1.5'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1;
            min-width: 0;
        }
        .glass-select:focus {
            border-color: var(--accent-blue);
            box-shadow: var(--shadow-glow), inset 0 1px 0 var(--glass-highlight);
            color: var(--text-primary);
        }
        .glass-select option {
            background: #2c2c2e;
            color: var(--text-primary);
        }

        /* --- Verb filter tags --- */
        .verb-tags {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            padding: 8px 0;
        }
        .verb-tag {
            padding: 5px 14px;
            font-family: var(--font-body);
            font-size: 0.78rem;
            font-weight: 600;
            letter-spacing: 0.01em;
            border: 1px solid var(--glass-border);
            background: var(--glass-bg-light);
            color: var(--text-tertiary);
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: var(--radius-pill);
            -webkit-backdrop-filter: blur(8px);
            backdrop-filter: blur(8px);
            box-shadow: inset 0 1px 0 var(--glass-highlight);
        }
        .verb-tag:hover {
            background: var(--glass-bg-heavy);
            color: var(--text-secondary);
            border-color: rgba(255, 255, 255, 0.20);
        }
        .verb-tag-active {
            background: rgba(0, 122, 255, 0.18) !important;
            color: var(--accent-blue) !important;
            border-color: rgba(0, 122, 255, 0.35) !important;
        }

        /* --- Presets --- */
        .presets-row {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            align-items: center;
            padding: 4px 0;
        }
        .preset-chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 10px;
            font-family: var(--font-body);
            font-size: 0.7rem;
            font-weight: 600;
            border: 1px solid var(--glass-border);
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-secondary);
            border-radius: var(--radius-pill);
        }
        .preset-chip button { background: none; border: none; color: inherit; cursor: pointer; font-size: 0.75rem; }
        .preset-chip button:hover { color: var(--accent-red); }
        .save-preset-btn {
            padding: 3px 12px;
            font-family: var(--font-body);
            font-size: 0.7rem;
            font-weight: 600;
            border: 1px dashed var(--text-quaternary);
            background: transparent;
            color: var(--text-tertiary);
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: var(--radius-pill);
        }
        .save-preset-btn:hover { border-color: var(--accent-blue); color: var(--accent-blue); }

        /* --- Theme switcher --- */
        .theme-switcher {
            padding: 7px 28px 7px 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            color: var(--text-secondary);
            font-family: var(--font-body);
            font-size: 0.8rem;
            font-weight: 600;
            outline: none;
            cursor: pointer;
            transition: all 0.2s ease;
            appearance: none;
            border-radius: var(--radius-pill);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' viewBox='0 0 10 6'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%238892b0' fill='none' stroke-width='1.5'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
        }
        .theme-switcher:focus {
            border-color: var(--accent-blue);
            box-shadow: var(--shadow-glow);
        }
        .theme-switcher option {
            background: #2c2c2e;
            color: var(--text-primary);
        }

        /* --- Recent searches dropdown --- */
        .recent-dropdown {
            display: none;
            position: absolute;
            left: 0; right: 0;
            top: 100%;
            margin-top: 6px;
            background: rgba(44, 44, 46, 0.95);
            -webkit-backdrop-filter: var(--glass-blur);
            backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            z-index: 50;
            max-height: 256px;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }
        .recent-dropdown button {
            display: block;
            width: 100%;
            text-align: left;
            padding: 8px 14px;
            font-family: var(--font-body);
            font-size: 0.85rem;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .recent-dropdown button:first-child { border-radius: var(--radius-md) var(--radius-md) 0 0; }
        .recent-dropdown button:last-child { border-radius: 0 0 var(--radius-md) var(--radius-md); }
        .recent-dropdown button:hover { background: rgba(0, 122, 255, 0.12); color: var(--accent-blue); }
        .recent-dropdown .clear-btn { font-size: 0.75rem; color: var(--text-tertiary); border-top: 1px solid var(--glass-border); }
        .recent-dropdown .clear-btn:hover { color: var(--accent-red); }

        /* --- Export menu --- */
        .export-menu {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            margin-top: 6px;
            background: rgba(44, 44, 46, 0.95);
            -webkit-backdrop-filter: var(--glass-blur);
            backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            z-index: 50;
            min-width: 120px;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
        }
        .export-menu button {
            display: block;
            width: 100%;
            text-align: left;
            padding: 8px 14px;
            font-family: var(--font-body);
            font-size: 0.85rem;
            font-weight: 500;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .export-menu button:hover { background: rgba(0, 122, 255, 0.12); color: var(--accent-blue); }

        .install-help {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            margin-top: 6px;
            background: rgba(44, 44, 46, 0.95);
            -webkit-backdrop-filter: var(--glass-blur);
            backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            z-index: 50;
            min-width: 300px;
            box-shadow: var(--shadow-lg);
            padding: 14px;
        }
        .install-help-title {
            font-family: var(--font-body);
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 10px;
        }
        .install-help-note {
            font-family: var(--font-body);
            font-size: 0.8rem;
            color: var(--text-tertiary);
            margin-bottom: 10px;
            line-height: 1.4;
        }
        .install-help-cmd {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(0, 0, 0, 0.25);
            border-radius: var(--radius-sm);
            padding: 8px 10px;
            margin-bottom: 6px;
        }
        .install-help-cmd:last-child { margin-bottom: 0; }
        .install-help-cmd code {
            flex: 1;
            font-family: var(--font-mono);
            font-size: 0.78rem;
            color: var(--text-primary);
            word-break: break-all;
        }
        .install-help-cmd .copy-btn {
            flex-shrink: 0;
            background: none;
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            cursor: pointer;
            padding: 3px 6px;
            font-size: 0.7rem;
            font-family: var(--font-body);
            transition: all 0.15s ease;
        }
        .install-help-cmd .copy-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-primary);
        }

        /* --- Main grid --- */
        .main-content {
            padding: 24px 0 80px;
        }
        .cards-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }

        /* --- Cmdlet cards --- */
        .cmdlet-card {
            position: relative;
            background: var(--glass-bg);
            -webkit-backdrop-filter: var(--glass-blur);
            backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            padding: 16px 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            opacity: 0;
            box-shadow: var(--shadow-sm), inset 0 1px 0 var(--glass-highlight);
        }
        .cmdlet-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md), inset 0 1px 0 var(--glass-highlight);
            background: var(--glass-bg-heavy);
        }

        /* Verb accent indicators */
        .cmdlet-card::before {
            content: '';
            position: absolute;
            top: 14px;
            left: 0;
            width: 3px;
            height: 24px;
            border-radius: 0 3px 3px 0;
            background: var(--text-quaternary);
            transition: all 0.2s ease;
        }
        .cmdlet-card.verb-get::before, .cmdlet-card.verb-find::before { background: var(--accent-green); }
        .cmdlet-card.verb-set::before, .cmdlet-card.verb-update::before { background: var(--accent-orange); }
        .cmdlet-card.verb-new::before, .cmdlet-card.verb-confirm::before { background: var(--accent-blue); }
        .cmdlet-card.verb-remove::before, .cmdlet-card.verb-clear::before { background: var(--accent-red); }
        .cmdlet-card.verb-invoke::before { background: var(--accent-teal); }
        .cmdlet-card.verb-add::before { background: var(--accent-purple); }
        .cmdlet-card.verb-connect::before, .cmdlet-card.verb-disconnect::before { background: var(--text-tertiary); }

        .card-name {
            font-family: var(--font-mono);
            font-size: 0.88rem;
            font-weight: 500;
            color: var(--text-primary);
            word-break: break-all;
            line-height: 1.3;
        }
        .card-name a {
            color: var(--text-quaternary);
            text-decoration: none;
            margin-left: 4px;
            transition: color 0.15s ease;
        }
        .card-name a:hover { color: var(--accent-blue); }
        .card-name a svg { display: inline-block; width: 12px; height: 12px; vertical-align: -1px; }

        .card-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 6px;
        }

        .card-badges {
            display: flex;
            align-items: center;
            gap: 5px;
            flex-shrink: 0;
        }

        .glass-badge {
            font-family: var(--font-body);
            font-size: 0.65rem;
            font-weight: 600;
            letter-spacing: 0.02em;
            padding: 2px 8px;
            border-radius: var(--radius-pill);
            border: 1px solid;
        }
        .badge-module { color: var(--accent-blue); border-color: rgba(0, 122, 255, 0.15); background: rgba(0, 122, 255, 0.10); }
        .badge-category { color: var(--text-tertiary); border-color: var(--glass-border); background: rgba(255, 255, 255, 0.05); }
        .badge-examples { color: var(--accent-green); border-color: rgba(52, 199, 89, 0.15); background: rgba(52, 199, 89, 0.10); }

        .card-desc {
            font-family: var(--font-body);
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.55;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            margin-bottom: 8px;
        }
        .card-expanded .card-desc { -webkit-line-clamp: unset; line-clamp: unset; }

        .card-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 8px;
        }

        .card-detail { min-height: 0; }

        .card-focused {
            outline: 2px solid var(--accent-blue);
            outline-offset: 2px;
            box-shadow: var(--shadow-glow), var(--shadow-sm);
        }

        /* --- Detail sections --- */
        .detail-syntax {
            position: relative;
            background: rgba(0, 0, 0, 0.25);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-sm);
            padding: 14px 44px 14px 14px;
            font-family: var(--font-mono);
            font-size: 0.82rem;
            color: var(--text-primary);
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-all;
            line-height: 1.7;
            margin-bottom: 10px;
        }

        .copy-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            padding: 5px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid var(--glass-border);
            border-radius: 6px;
            color: var(--text-tertiary);
            cursor: pointer;
            opacity: 0;
            transition: all 0.15s ease;
        }
        .copy-btn:hover { color: var(--accent-blue); border-color: rgba(0, 122, 255, 0.2); background: rgba(0, 122, 255, 0.06); }
        .detail-syntax:hover .copy-btn,
        .example-block:hover .copy-btn,
        .copy-btn:focus { opacity: 1; }

        details { margin-bottom: 6px; }
        details[open] > summary svg.chevron { transform: rotate(90deg); }
        summary { list-style: none; cursor: pointer; }
        summary::-webkit-details-marker { display: none; }

        .detail-summary {
            display: flex;
            align-items: center;
            gap: 6px;
            font-family: var(--font-body);
            font-size: 0.88rem;
            font-weight: 500;
            color: var(--text-tertiary);
            padding: 4px 0;
            transition: color 0.15s ease;
        }
        .detail-summary:hover { color: var(--text-secondary); }
        .detail-summary svg { width: 12px; height: 12px; transition: transform 0.15s ease; }

        .params-table {
            width: 100%;
            font-family: var(--font-mono);
            font-size: 0.78rem;
            border-collapse: collapse;
            margin-top: 4px;
        }
        .params-table th {
            text-align: left;
            padding: 6px 14px 6px 0;
            color: var(--text-tertiary);
            font-weight: 500;
            font-family: var(--font-body);
            font-size: 0.7rem;
            border-bottom: 1px solid var(--glass-border);
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }
        .params-table td {
            padding: 6px 14px 6px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }
        .params-table .param-name { color: var(--accent-blue); }
        .params-table .param-type { color: var(--text-secondary); }
        .params-table .param-req { color: var(--accent-orange); font-weight: 600; }
        .params-table .param-opt { color: var(--text-quaternary); }

        .example-block {
            position: relative;
            background: rgba(0, 0, 0, 0.25);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-sm);
            padding: 12px 44px 12px 12px;
            font-family: var(--font-mono);
            font-size: 0.8rem;
            color: var(--text-secondary);
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-all;
            line-height: 1.6;
            margin-bottom: 6px;
        }

        .related-btn {
            font-family: var(--font-mono);
            font-size: 0.78rem;
            padding: 4px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s ease;
            border-radius: var(--radius-pill);
        }
        .related-btn:hover { color: var(--accent-blue); border-color: rgba(0, 122, 255, 0.2); background: rgba(0, 122, 255, 0.12); }

        /* --- PowerShell syntax highlighting --- */
        .ps-comment { color: var(--accent-green); font-style: italic; }
        .ps-string { color: #ff6b6b; }
        .ps-variable { color: var(--accent-blue); }
        .ps-cmdlet { color: var(--accent-indigo); }
        .ps-type { color: var(--accent-purple); }

        /* --- Loading spinner --- */
        .glass-spinner {
            display: inline-block;
            width: 28px;
            height: 28px;
            border: 2.5px solid var(--glass-border);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        .glass-spinner-sm {
            width: 16px;
            height: 16px;
            border-width: 2px;
        }

        .loading-text {
            font-family: var(--font-body);
            font-size: 0.82rem;
            font-weight: 500;
            color: var(--text-tertiary);
            margin-top: 10px;
        }

        /* --- No results --- */
        .no-results {
            display: none;
            text-align: center;
            padding: 60px 20px;
        }
        .no-results h3 {
            font-family: var(--font-display);
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-secondary);
        }
        .no-results p {
            font-family: var(--font-body);
            font-size: 0.82rem;
            color: var(--text-tertiary);
            margin-top: 6px;
        }

        /* --- Alpha nav --- */
        .alpha-nav {
            display: none;
            position: fixed;
            right: 8px;
            top: 300px;
            bottom: 16px;
            justify-content: center;
            flex-direction: column;
            align-items: center;
            gap: 1px;
            z-index: 30;
            font-family: var(--font-body);
            font-size: 0.58rem;
            font-weight: 600;
            background: var(--glass-bg-heavy);
            -webkit-backdrop-filter: var(--glass-blur);
            backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-pill);
            padding: 6px 2px;
            box-shadow: var(--shadow-md);
        }
        @media (min-width: 1024px) { .alpha-nav { display: flex; } }
        .alpha-nav button {
            padding: 2px 5px;
            background: none;
            border: none;
            color: var(--text-tertiary);
            cursor: pointer;
            transition: color 0.1s ease;
            border-radius: 4px;
            line-height: 1.3;
        }
        .alpha-nav button:hover { color: var(--accent-blue); background: rgba(0, 122, 255, 0.08); }

        /* --- Back to top --- */
        .back-to-top {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 12px;
            background: var(--glass-bg-heavy);
            -webkit-backdrop-filter: var(--glass-blur);
            backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border);
            color: var(--text-secondary);
            cursor: pointer;
            z-index: 30;
            opacity: 0;
            pointer-events: none;
            transition: all 0.2s ease;
            border-radius: 50%;
            box-shadow: var(--shadow-md);
        }
        .back-to-top:hover { color: var(--accent-blue); }
        .back-to-top.visible { opacity: 1; pointer-events: auto; }
        .back-to-top svg { width: 18px; height: 18px; }

        /* --- Responsive --- */

        /* Tablet */
        @media (max-width: 768px) {
            .app-container { padding: 0 16px; }
            .stats-row { gap: 10px; }
            .stat-block .stat-value { font-size: 1.1rem; }
            .filter-bar { position: relative; top: auto; }
            .main-content { padding: 16px 0 80px; }
        }

        /* Mobile */
        @media (max-width: 640px) {
            .app-container { padding: 0 12px; }

            /* Header compact */
            .header-bar { padding: 8px 0; }
            .header-inner { flex-direction: column; align-items: flex-start; gap: 8px; }
            .logo-block h1 { font-size: 1.15rem; }
            .logo-block .subtitle { display: none; }

            /* Stats row compact */
            .stats-row { gap: 8px; width: 100%; justify-content: flex-start; flex-wrap: wrap; }
            .stat-block .stat-value { font-size: 1rem; }
            .stat-block .stat-label { font-size: 0.5rem; }
            .stat-divider { height: 20px; }

            /* Filter bar */
            .filter-bar { position: relative; top: auto; padding: 10px 0; }
            .filter-bar > .app-container { padding: 10px 12px; }
            .filter-row { flex-direction: column; gap: 8px; }
            .glass-input, .glass-select, .search-wrap { width: 100%; max-width: 100%; box-sizing: border-box; }

            /* Verb tags hidden, toggle visible */
            .verb-tags { display: none; }

            /* Cards compact */
            .cmdlet-card { padding: 12px 14px; }
            .card-name { font-size: 0.82rem; }
            .card-desc { font-size: 0.8rem; }
            .card-header { flex-direction: column; gap: 6px; }
            .card-badges { align-self: flex-start; }

            /* Contain expanded card content within viewport */
            .cmdlet-card, .card-detail, .detail-syntax, .params-table, .example-block, details { max-width: 100%; box-sizing: border-box; }
            .cmdlet-card, .card-detail, details { overflow: hidden; }

            /* Detail sections compact */
            .detail-syntax { padding: 10px 36px 10px 10px; font-size: 0.78rem; }
            .params-table { display: block; overflow-x: auto; }
            .params-table th, .params-table td { padding: 4px 8px; font-size: 0.75rem; white-space: nowrap; }

            /* Back to top - touch friendly */
            .back-to-top { bottom: 16px; right: 16px; padding: 12px; }
            .back-to-top svg { width: 20px; height: 20px; }

            /* Main content */
            .main-content { padding: 12px 0 80px; }

            /* Theme switcher compact */
            .theme-switcher { font-size: 0.7rem; padding: 4px 20px 4px 6px; }

            /* Onboarding tooltip */
            .onboarding-tip { max-width: calc(100vw - 32px); }
        }

        /* Small phones */
        @media (max-width: 380px) {
            .app-container { padding: 0 8px; }
            .logo-block h1 { font-size: 1rem; }
            .stat-divider { display: none; }
            .stats-row { gap: 12px; }
        }

        /* --- Mobile filter toggle --- */
        .mobile-filter-toggle {
            display: none;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            font-family: var(--font-body);
            font-size: 0.8rem;
            font-weight: 600;
            border: 1px solid var(--glass-border);
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-tertiary);
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: var(--radius-pill);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            margin-top: 4px;
        }
        .mobile-filter-toggle:hover { color: var(--accent-blue); border-color: rgba(0, 122, 255, 0.2); }
        @media (max-width: 640px) { .mobile-filter-toggle { display: inline-flex; } }
        .filter-badge {
            display: none;
            padding: 1px 6px;
            font-size: 0.65rem;
            font-weight: 700;
            background: rgba(0, 122, 255, 0.12);
            color: var(--accent-blue);
            border-radius: var(--radius-pill);
        }
        .filter-badge.active { display: inline; }

        .hidden { display: none !important; }

        /* --- Onboarding tooltip --- */
        .onboarding-overlay {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 50;
            pointer-events: none;
        }
        .onboarding-tip {
            position: absolute;
            background: var(--glass-bg-heavy);
            -webkit-backdrop-filter: var(--glass-blur);
            backdrop-filter: var(--glass-blur);
            border: 1px solid rgba(0, 122, 255, 0.25);
            border-radius: var(--radius-md);
            padding: 16px;
            max-width: 300px;
            pointer-events: auto;
            box-shadow: var(--shadow-lg);
            filter: drop-shadow(0 4px 12px rgba(0,0,0,0.25));
        }
        .onboarding-tip p {
            font-family: var(--font-body);
            font-size: 0.88rem;
            color: var(--text-primary);
            line-height: 1.5;
            margin-bottom: 12px;
        }
        .onboarding-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        .onboarding-dismiss {
            padding: 4px 12px;
            font-family: var(--font-body);
            font-size: 0.78rem;
            font-weight: 500;
            background: none;
            border: none;
            color: var(--text-tertiary);
            cursor: pointer;
            transition: color 0.15s;
        }
        .onboarding-dismiss:hover { color: var(--text-secondary); }
        .onboarding-next {
            padding: 4px 14px;
            font-family: var(--font-body);
            font-size: 0.78rem;
            font-weight: 600;
            background: rgba(0, 122, 255, 0.12);
            border: none;
            color: var(--accent-blue);
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.15s;
        }
        .onboarding-next:hover { background: rgba(0, 122, 255, 0.2); }

        /* --- Progressive enhancement fallback --- */
        @supports not (backdrop-filter: blur(1px)) {
            .glass-panel, .header-bar, .filter-bar, .glass-input, .glass-select,
            .theme-switcher, .recent-dropdown, .export-menu, .alpha-nav,
            .back-to-top, .icon-btn, .mobile-filter-toggle {
                background-color: var(--dark-surface) !important;
            }
        }

        /* --- High contrast --- */
        @media (prefers-contrast: high) {
            :root { --glass-border: rgba(255, 255, 255, 0.30); --text-primary: #fff; }
        }

        /* --- Selection --- */
        ::selection { background: rgba(0, 122, 255, 0.3); color: #fff; }

        /* --- Light mode --- */
        :root.light {
            color-scheme: light;
            --glass-bg: rgba(255, 255, 255, 0.70);
            --glass-bg-heavy: rgba(255, 255, 255, 0.80);
            --glass-bg-light: rgba(255, 255, 255, 0.50);
            --glass-border: rgba(0, 0, 0, 0.08);
            --glass-highlight: rgba(255, 255, 255, 0.90);
            --glass-blur: blur(20px) saturate(180%);
            --glass-blur-heavy: blur(40px) saturate(190%);
            --dark-surface: rgba(242, 242, 247, 0.95);
            --text-primary: rgba(0, 0, 0, 0.85);
            --text-secondary: rgba(0, 0, 0, 0.55);
            --text-tertiary: rgba(0, 0, 0, 0.35);
            --text-quaternary: rgba(0, 0, 0, 0.18);
            --accent-blue: #007AFF;
            --accent-indigo: #5856D6;
            --accent-teal: #32ADE6;
            --accent-green: #34C759;
            --accent-orange: #FF9500;
            --accent-red: #FF3B30;
            --accent-pink: #FF2D55;
            --accent-purple: #AF52DE;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 2px 8px rgba(0, 0, 0, 0.10);
            --shadow-lg: 0 4px 16px rgba(0, 0, 0, 0.12);
            --shadow-glow: 0 0 0 4px rgba(0, 122, 255, 0.25);
        }

        :root.light body {
            background: #f2f2f7;
            background-image: none;
        }

        :root.light .header-bar,
        :root.light .filter-bar {
            background: rgba(242, 242, 247, 0.80);
        }

        :root.light .recent-dropdown,
        :root.light .export-menu,
        :root.light .install-help {
            background: rgba(255, 255, 255, 0.95);
        }

        :root.light .glass-select option,
        :root.light .theme-switcher option {
            background: #ffffff;
            color: rgba(0, 0, 0, 0.85);
        }

        :root.light .detail-syntax,
        :root.light .example-block {
            background: rgba(0, 0, 0, 0.03);
        }

        :root.light .onboarding-tip {
            background: rgba(255, 255, 255, 0.95);
        }

        :root.light .glass-spinner {
            border-color: rgba(0, 0, 0, 0.08);
            border-top-color: var(--accent-blue);
        }

        :root.light ::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.02); }
        :root.light ::-webkit-scrollbar-thumb { background: rgba(0, 0, 0, 0.15); }
        :root.light ::-webkit-scrollbar-thumb:hover { background: rgba(0, 0, 0, 0.25); }

        :root.light ::selection { background: rgba(0, 122, 255, 0.2); color: #000; }

        :root.light .badge-module { background: rgba(0, 122, 255, 0.08); border-color: rgba(0, 122, 255, 0.15); }
        :root.light .badge-examples { background: rgba(52, 199, 89, 0.08); border-color: rgba(52, 199, 89, 0.15); }
        :root.light .badge-category { background: rgba(0, 0, 0, 0.03); border-color: rgba(0, 0, 0, 0.08); }

        @supports not (backdrop-filter: blur(1px)) {
            :root.light .glass-panel, :root.light .header-bar, :root.light .filter-bar,
            :root.light .glass-input, :root.light .glass-select, :root.light .theme-switcher,
            :root.light .recent-dropdown, :root.light .export-menu, :root.light .alpha-nav,
            :root.light .back-to-top, :root.light .icon-btn, :root.light .mobile-filter-toggle {
                background-color: rgba(255, 255, 255, 0.92) !important;
            }
        }

        /* --- Suite navigation --- */
        .suite-nav {
            display: flex;
            gap: 4px;
            align-items: center;
        }
        .suite-link {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 12px;
            font-family: var(--font-body);
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.01em;
            text-decoration: none;
            color: var(--text-tertiary);
            border: 1px solid var(--glass-border);
            background: var(--glass-bg-light);
            border-radius: var(--radius-pill);
            transition: all 0.2s ease;
            -webkit-backdrop-filter: blur(8px);
            backdrop-filter: blur(8px);
            white-space: nowrap;
        }
        .suite-link:hover {
            color: var(--text-secondary);
            background: var(--glass-bg);
            border-color: rgba(255, 255, 255, 0.15);
        }
        .suite-link.active {
            color: var(--accent-blue);
            background: rgba(0, 122, 255, 0.12);
            border-color: rgba(0, 122, 255, 0.25);
        }
        :root.light .suite-link:hover {
            border-color: rgba(0, 0, 0, 0.12);
        }
        :root.light .suite-link.active {
            background: rgba(0, 122, 255, 0.08);
            border-color: rgba(0, 122, 255, 0.20);
        }
        .suite-icon {
            font-family: var(--font-mono);
            font-size: 0.65rem;
            font-weight: 700;
            padding: 1px 4px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.08);
            letter-spacing: 0;
        }
        :root.light .suite-icon {
            background: rgba(0, 0, 0, 0.06);
        }
        .suite-link.active .suite-icon {
            background: rgba(0, 122, 255, 0.15);
        }
        @media (max-width: 640px) {
            .suite-link span:not(.suite-icon) { display: none; }
            .suite-link { padding: 5px 8px; }
        }

    </style>
</head>
<body>

    <div class="header-bar">
        <div class="app-container">
            <div class="header-inner">
                <div class="logo-block">
                    <h1><span>Exch</span> Index</h1>
                    <div class="subtitle">Exchange & Office PowerShell Cmdlet Index</div>
                </div>
                <nav class="suite-nav">
                    <a href="https://jorgeasaurus.github.io/AzIndex/" class="suite-link"><span class="suite-icon">Az</span> <span>Azure</span></a>
                    <a href="https://jorgeasaurus.github.io/MecmIndex/" class="suite-link"><span class="suite-icon">CM</span> <span>MECM</span></a>
                    <a href="https://jorgeasaurus.github.io/MgGraphIndex/" class="suite-link"><span class="suite-icon">Mg</span> <span>Graph</span></a>
                    <a href="https://jorgeasaurus.github.io/EntraIndex/" class="suite-link"><span class="suite-icon">En</span> <span>Entra</span></a>
                    <a href="https://jorgeasaurus.github.io/ExchIndex/" class="suite-link active"><span class="suite-icon">Ex</span> <span>Exchange</span></a>
                </nav>
                <div class="stats-row">
                    <div class="stat-block">
                        <div class="stat-value" id="moduleVersion">--</div>
                        <div class="stat-label">Module</div>
                    </div>
                    <div class="stat-divider"></div>
                    <div class="stat-block">
                        <div class="stat-value" id="totalCmdlets">0</div>
                        <div class="stat-label">Total</div>
                    </div>
                    <div class="stat-divider"></div>
                    <div class="stat-block">
                        <div class="stat-value" id="filteredCount">0</div>
                        <div class="stat-label">Showing</div>
                    </div>
                    <div class="stat-divider"></div>
                    <div style="position:relative" id="installHelpWrap">
                        <button onclick="toggleInstallHelp()" class="icon-btn" aria-label="Install help" title="Module install instructions">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        </button>
                        <div id="installHelp" class="install-help">
                            <div class="install-help-title">Install Modules</div>
                            <div class="install-help-cmd"><code>Install-Module ExchangeOnlineManagement -Scope CurrentUser</code><button class="copy-btn" onclick="navigator.clipboard.writeText('Install-Module ExchangeOnlineManagement -Scope CurrentUser');this.textContent='Copied';setTimeout(()=>this.textContent='Copy',1500)" title="Copy">Copy</button></div>
                            <div class="install-help-cmd"><code>Install-Module MicrosoftTeams -Scope CurrentUser</code><button class="copy-btn" onclick="navigator.clipboard.writeText('Install-Module MicrosoftTeams -Scope CurrentUser');this.textContent='Copied';setTimeout(()=>this.textContent='Copy',1500)" title="Copy">Copy</button></div>
                        </div>
                    </div>
                    <div style="position:relative" id="exportWrap">
                        <button onclick="toggleExportMenu()" class="icon-btn" aria-label="Export" title="Export filtered results">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                        </button>
                        <div id="exportMenu" class="export-menu">
                            <button onclick="exportResults('json')">JSON</button>
                            <button onclick="exportResults('csv')">CSV</button>
                        </div>
                    </div>
                    <button onclick="toggleAppearance()" class="icon-btn" id="appearanceToggle" aria-label="Toggle light/dark mode">
                        <svg id="iconSun" style="display:none" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
                        <svg id="iconMoon" style="display:none" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg>
                    </button>
                    <select class="theme-switcher" id="themeSwitcher" aria-label="Switch theme" onchange="switchTheme(this.value)">
                        <option value="index.html" selected>Acrylic</option>
                        <option value="cyberpunk.html">Cyberpunk</option>
                        <option value="crt.html">CRT</option>
                        <option value="synthwave.html">Synthwave</option>
                        <option value="blueprint.html">Blueprint</option>
                        <option value="solarized.html">Solarized</option>
                        <option value="geocities.html">Geocities</option>
                        <option value="ise.html">ISE</option>
                        <option value="nord.html">Nord</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <div class="filter-bar">
        <div class="app-container">
            <div class="filter-row">
                <div class="search-wrap">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                    <input type="text" class="glass-input" id="searchInput" placeholder="Search">
                    <div id="recentSearches" class="recent-dropdown"></div>
                </div>
                <select class="glass-select" id="categoryFilter" aria-label="Category"><option value="">All Categories</option></select>
                <select class="glass-select" id="moduleFilter" aria-label="Module"><option value="">All Modules</option></select>
                <select class="glass-select" id="sortSelect" aria-label="Sort">
                    <option value="alpha">Sort: A-Z</option>
                    <option value="category">Sort: Category</option>
                    <option value="module">Sort: Module</option>
                    <option value="examples">Sort: Examples</option>
                </select>
            </div>
            <button class="mobile-filter-toggle" onclick="toggleMobileFilters()">Filters <span id="filterBadge" class="filter-badge"></span></button>
            <div class="verb-tags" id="verbFilters"></div>
            <div class="presets-row" id="presetsBar">
                <div id="presetsList" style="display:flex;gap:6px;flex-wrap:wrap"></div>
                <button onclick="savePreset()" class="save-preset-btn">+ Save Preset</button>
            </div>
        </div>
    </div>

    <div class="app-container">
        <main class="main-content">
            <div class="cards-grid" id="cmdletsGrid">
                <div style="text-align:center;padding:60px 20px">
                    <div class="glass-spinner"></div>
                    <div class="loading-text">Loading cmdlets...</div>
                </div>
            </div>
            <div class="no-results" id="noResults">
                <h3>No Matches Found</h3>
                <p>Try adjusting your search or filters</p>
            </div>
            <div id="scrollSentinel" style="height:1px"></div>
        </main>
    </div>

    <nav class="alpha-nav" id="alphaIndex"></nav>

    <button class="back-to-top" id="backToTop" onclick="window.scrollTo({top:0,behavior:'smooth'})" aria-label="Back to top">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/></svg>
    </button>

    <!-- Onboarding tooltip container -->
    <div id="onboardingOverlay" class="onboarding-overlay">
        <div id="onboardingTip" class="onboarding-tip">
            <p id="tipText"></p>
            <div class="onboarding-actions">
                <button onclick="dismissOnboarding()" class="onboarding-dismiss">Dismiss</button>
                <button onclick="showNextTip()" class="onboarding-next">Next</button>
            </div>
        </div>
    </div>

    <script>
        let cmdlets = [];
        let filteredCmdlets = [];
        let activeVerbs = new Set();
        let renderedCount = 0;
        const CHUNK_SIZE = 50;
        let scrollObserver = null;
        let focusedCardIndex = -1;
        let recentSearches = JSON.parse(localStorage.getItem('exchRecentSearches') || '[]');
        let nounMap = {};
        let currentSort = 'alpha';
        let savedPresets = JSON.parse(localStorage.getItem('exchSavedPresets') || '[]');
        let hasSeenOnboarding = localStorage.getItem('exchHasSeenOnboarding') === 'true';
        let onboardingStep = 0;
        let descriptionsLoaded = false;
        const moduleDetailCache = new Map();

        function debounce(fn, ms) {
            let id;
            return (...args) => { clearTimeout(id); id = setTimeout(() => fn(...args), ms); };
        }

        function escapeHtml(str) {
            if (!str) return '';
            return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
        }

        function getVerb(name) {
            const idx = name.indexOf('-');
            return idx > 0 ? name.substring(0, idx) : '';
        }

        async function loadCmdlets() {
            try {
                const response = await fetch('data/manifest.json');
                if (!response.ok) throw new Error('HTTP ' + response.status);
                const wrapper = await response.json();
                if (wrapper.v) {
                    var verEl = document.getElementById('moduleVersion');
                    if (verEl) verEl.textContent = 'v' + wrapper.v;
                }
                const data = wrapper.d || wrapper;
                cmdlets = data.map(c => ({
                    name: c.n || 'Unknown Cmdlet',
                    verb: c.v || getVerb(c.n || ''),
                    category: c.c || 'General',
                    module: c.m || '',
                    description: '',
                    hasExamples: !!c.e,
                }));
                buildNounMap(); filteredCmdlets = [...cmdlets]; populateFilters(); restoreState();
                if (!hasSeenOnboarding) setTimeout(showNextTip, 800);
                loadDescriptions();
                loadAllModuleDetails();
            } catch (e) {
                console.warn('Manifest load failed, trying cmdlets.json:', e.message);
                try {
                    const response = await fetch('data/cmdlets.json');
                    if (!response.ok) throw new Error('HTTP ' + response.status);
                    const data = await response.json();
                    const arr = Array.isArray(data) ? data : (data.cmdlets || [data]);
                    arr.forEach(function(c) {
                        var mod = c.module || '';
                        if (!mod) return;
                        if (!moduleDetailCache.has(mod)) moduleDetailCache.set(mod, { module: mod, cmdlets: {} });
                        moduleDetailCache.get(mod).cmdlets[c.name] = {
                            syntax: c.syntax || '',
                            examples: Array.isArray(c.examples) ? c.examples : (c.examples ? [c.examples] : []),
                        };
                    });
                    cmdlets = arr.map(c => ({
                        name: c.name || 'Unknown Cmdlet',
                        verb: c.verb || getVerb(c.name || ''),
                        category: c.category || 'General',
                        module: c.module || '',
                        description: c.description || 'Office PowerShell cmdlet.',
                        hasExamples: Array.isArray(c.examples) && c.examples.length > 0,
                    }));
                    buildNounMap(); filteredCmdlets = [...cmdlets];
                    populateFilters(); restoreState();
                    if (!hasSeenOnboarding) setTimeout(showNextTip, 800);
                } catch (e2) {
                    document.getElementById('cmdletsGrid').innerHTML = '<div style="text-align:center;padding:60px 20px"><h3 style="font-family:var(--font-display);font-size:1rem;font-weight:600;color:var(--accent-red)">Unable to Load Data</h3><p style="color:var(--text-tertiary);font-family:var(--font-body);font-size:0.82rem;margin-top:8px">Could not connect to data source. Run the extraction script first.</p></div>';
                }
            }
        }

        async function loadModuleDetail(moduleName) {
            if (moduleDetailCache.has(moduleName)) return moduleDetailCache.get(moduleName);
            try {
                const response = await fetch('data/modules/' + encodeURIComponent(moduleName) + '.json');
                if (!response.ok) throw new Error('HTTP ' + response.status);
                const data = await response.json();
                moduleDetailCache.set(moduleName, data);
                return data;
            } catch (e) {
                console.warn('Module detail fetch failed for ' + moduleName + ':', e.message);
                return null;
            }
        }

        async function loadAllModuleDetails() {
            var modules = [...new Set(cmdlets.map(function(c) { return c.module; }).filter(function(m) { return m; }))];
            await Promise.all(modules.map(function(m) { return loadModuleDetail(m); }));
        }

        async function loadDescriptions() {
            try {
                var resp = await fetch('data/descriptions.json');
                if (!resp.ok) throw new Error('HTTP ' + resp.status);
                var descMap = await resp.json();
                cmdlets.forEach(function(c) {
                    c.description = descMap[c.name] || 'Office PowerShell cmdlet.';
                });
                descriptionsLoaded = true;
                updateRenderedDescriptions(descMap);
                var searchTerm = document.getElementById('searchInput').value.trim();
                if (searchTerm) filterCmdlets();
            } catch (e) {
                console.warn('Descriptions load failed:', e.message);
                descriptionsLoaded = true;
            }
        }

        function updateRenderedDescriptions(descMap) {
            document.querySelectorAll('.cmdlet-card').forEach(function(card) {
                var name = card.dataset.name;
                if (!name) return;
                var desc = descMap[name] || 'Office PowerShell cmdlet.';
                var el = card.querySelector('.card-desc');
                if (el) el.textContent = desc;
            });
        }

        async function populateCardDetail(card, cmdletName, moduleName) {
            const detailContainer = card.querySelector('.card-detail');
            if (!detailContainer || detailContainer.dataset.loaded === 'true') return;
            detailContainer.innerHTML = '<div style="text-align:center;padding:12px"><div class="glass-spinner glass-spinner-sm" style="display:inline-block"></div><div style="font-family:var(--font-body);font-size:0.7rem;color:var(--text-tertiary);margin-top:4px">Loading details...</div></div>';
            const moduleData = await loadModuleDetail(moduleName);
            if (!moduleData || !moduleData.cmdlets || !moduleData.cmdlets[cmdletName]) {
                detailContainer.innerHTML = '<p style="font-family:var(--font-body);font-size:0.78rem;color:var(--text-tertiary);padding:8px 0">No additional details available</p>';
                detailContainer.dataset.loaded = 'true';
                return;
            }
            const detail = moduleData.cmdlets[cmdletName];
            let html = '';

            if (detail.syntax) {
                html += '<div class="detail-syntax">' + escapeHtml(detail.syntax) +
                    '<button class="copy-btn" data-copy-syntax="1" title="Copy" onclick="event.stopPropagation()"><svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg></button></div>';
            }

            if (detail.syntax) {
                const params = parseParameters(detail.syntax);
                if (params.length > 0) {
                    html += '<details onclick="event.stopPropagation()"><summary class="detail-summary"><svg class="chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg><span>' + params.length + ' parameter' + (params.length > 1 ? 's' : '') + '</span></summary>' +
                        '<table class="params-table"><thead><tr><th>Parameter</th><th>Type</th><th>Required</th></tr></thead><tbody>' +
                        params.map(function(p) {
                            return '<tr><td class="param-name">' + escapeHtml(p.name) + '</td><td class="param-type">' + escapeHtml(p.type) + '</td><td class="' + (p.required ? 'param-req' : 'param-opt') + '">' + (p.required ? 'Yes' : 'No') + '</td></tr>';
                        }).join('') + '</tbody></table></details>';
                }
            }

            if (detail.examples && detail.examples.length > 0) {
                html += '<details class="examples-section" onclick="event.stopPropagation()"><summary class="detail-summary"><svg class="chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg><span>' + detail.examples.length + ' example' + (detail.examples.length > 1 ? 's' : '') + '</span></summary><div style="margin-top:6px">' +
                    detail.examples.map(function(ex) {
                        return '<div class="example-block">' + highlightPowerShell(escapeHtml(ex)) +
                            '<button class="copy-btn" data-copy-ex="1" title="Copy" onclick="event.stopPropagation()"><svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg></button></div>';
                    }).join('') + '</div></details>';
            }

            const noun = cmdletName.indexOf('-') > 0 ? cmdletName.substring(cmdletName.indexOf('-') + 1) : '';
            const related = noun && nounMap[noun] ? nounMap[noun].filter(function(n) { return n !== cmdletName; }) : [];
            if (related.length > 0) {
                html += '<div style="display:flex;flex-wrap:wrap;gap:4px;margin-top:6px">' +
                    related.slice(0, 5).map(function(r) {
                        return '<button class="related-btn" onclick="event.stopPropagation();document.getElementById(\'searchInput\').value=\'' + escapeHtml(r) + '\';filterCmdlets()">' + escapeHtml(r) + '</button>';
                    }).join('') +
                    (related.length > 5 ? '<span style="font-family:var(--font-body);font-size:0.7rem;color:var(--text-tertiary);align-self:center;padding:0 4px">+' + (related.length - 5) + ' more</span>' : '') + '</div>';
            }

            detailContainer.innerHTML = html;
            detailContainer.dataset.loaded = 'true';
        }

        const tagBase = 'verb-tag';
        const tagInactive = '';
        const tagActive = 'verb-tag-active';

        function populateFilters() {
            const catSelect = document.getElementById('categoryFilter');
            const categories = [...new Set(cmdlets.map(c => c.category))].sort();
            catSelect.innerHTML = '<option value="">All Categories</option>' + categories.map(c => '<option value="' + escapeHtml(c) + '">' + escapeHtml(c) + '</option>').join('');

            const modSelect = document.getElementById('moduleFilter');
            const modules = [...new Set(cmdlets.map(c => c.module).filter(m => m))].sort();
            modSelect.innerHTML = '<option value="">All Modules</option>' + modules.map(m => {
                const short = m;
                return '<option value="' + escapeHtml(m) + '">' + escapeHtml(short) + '</option>';
            }).join('');

            const verbs = [...new Set(cmdlets.map(c => c.verb).filter(v => v))].sort();
            const vc = document.getElementById('verbFilters');
            vc.innerHTML = '<button class="verb-tag verb-tag-active" data-filter="all">All</button>' +
                verbs.map(v => '<button class="verb-tag" data-filter="' + escapeHtml(v) + '">' + escapeHtml(v.charAt(0).toUpperCase() + v.slice(1).toLowerCase()) + '</button>').join('');

            vc.querySelectorAll('button').forEach(function(tag) {
                tag.addEventListener('click', function() {
                    var filter = this.dataset.filter;
                    if (filter === 'all') { activeVerbs.clear(); }
                    else if (activeVerbs.has(filter)) { activeVerbs.delete(filter); }
                    else { activeVerbs.add(filter); }
                    refreshVerbButtonStyles();
                    filterCmdlets();
                });
            });
            renderPresets();
        }

        function filterCmdlets() {
            var searchTerm = document.getElementById('searchInput').value.trim();
            var searchLower = searchTerm.toLowerCase();
            var categoryVal = document.getElementById('categoryFilter').value;
            var moduleVal = document.getElementById('moduleFilter').value;
            currentSort = document.getElementById('sortSelect').value;
            if (searchTerm.length >= 2) saveRecentSearch(searchTerm);

            filteredCmdlets = cmdlets.filter(function(c) {
                if (searchLower) {
                    var nameRaw = fuzzyScore(searchLower, c.name);
                    var nameScore = nameRaw * (1 + searchLower.length / c.name.length);
                    var descScore = descriptionsLoaded ? fuzzyScore(searchLower, c.description) * 0.3 : 0;
                    c._score = nameScore + descScore + fuzzyScore(searchLower, c.category) * 0.2;
                    if (c._score < searchLower.length * 2) return false;
                } else { c._score = 0; }
                return (!categoryVal || c.category === categoryVal) &&
                    (!moduleVal || c.module === moduleVal) &&
                    (activeVerbs.size === 0 || activeVerbs.has(c.verb));
            });

            if (searchLower) { filteredCmdlets.sort((a, b) => b._score - a._score); }
            else {
                switch (currentSort) {
                    case 'category': filteredCmdlets.sort((a, b) => a.category.localeCompare(b.category) || a.name.localeCompare(b.name)); break;
                    case 'module': filteredCmdlets.sort((a, b) => (a.module || '').localeCompare(b.module || '') || a.name.localeCompare(b.name)); break;
                    case 'examples': filteredCmdlets.sort((a, b) => (b.hasExamples?1:0) - (a.hasExamples?1:0) || a.name.localeCompare(b.name)); break;
                    default: filteredCmdlets.sort((a, b) => a.name.localeCompare(b.name));
                }
            }
            focusedCardIndex = -1;
            renderCmdlets(); updateStats(); serializeState(); buildAlphaIndex(); updateFilterBadge();
        }

        function buildCardHtml(c, animDelay) {
            var verb = (c.verb || getVerb(c.name)).toLowerCase();
            var learnUrl = getLearnUrl(c);
            var learnLink = learnUrl ? ' <a href="' + learnUrl + '" target="_blank" rel="noopener" title="MS Learn" onclick="event.stopPropagation()"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg></a>' : '';
            var shortModule = c.module ? c.module : '';
            var moduleBadge = shortModule ? '<span class="glass-badge badge-module">' + escapeHtml(shortModule) + '</span>' : '';
            var exBadge = c.hasExamples ? '<span class="glass-badge badge-examples">Examples</span>' : '';

            return '<div class="cmdlet-card animate-fade-up verb-' + escapeHtml(verb) + '" style="animation-delay:' + animDelay + 'ms" data-name="' + escapeHtml(c.name) + '" data-module="' + escapeHtml(c.module) + '">' +
                '<div class="card-header"><div class="card-name">' + escapeHtml(c.name) + learnLink + '</div>' +
                '<div class="card-badges">' + moduleBadge + '<span class="glass-badge badge-category">' + escapeHtml(c.category) + '</span></div></div>' +
                '<p class="card-desc">' + (c.description ? escapeHtml(c.description) : '') + '</p>' +
                '<div class="card-meta">' + exBadge + '</div>' +
                '<div class="card-detail"></div></div>';
        }

        function renderNextChunk() {
            var grid = document.getElementById('cmdletsGrid');
            var chunk = filteredCmdlets.slice(renderedCount, renderedCount + CHUNK_SIZE);
            if (chunk.length === 0) return;
            var html = chunk.map((c, i) => buildCardHtml(c, Math.min(i * 15, 300))).join('');
            grid.insertAdjacentHTML('beforeend', html);
            renderedCount += chunk.length;
            if (renderedCount >= filteredCmdlets.length) {
                var sentinel = document.getElementById('scrollSentinel');
                if (scrollObserver && sentinel) scrollObserver.unobserve(sentinel);
            }
        }

        function renderCmdlets() {
            var grid = document.getElementById('cmdletsGrid');
            var noResults = document.getElementById('noResults');
            if (filteredCmdlets.length === 0) { grid.style.display = 'none'; noResults.style.display = 'block'; return; }
            grid.style.display = ''; noResults.style.display = 'none';
            renderedCount = 0; grid.innerHTML = '';
            renderNextChunk(); setupScrollObserver();
        }

        function setupScrollObserver() {
            if (scrollObserver) scrollObserver.disconnect();
            var sentinel = document.getElementById('scrollSentinel');
            scrollObserver = new IntersectionObserver(entries => {
                if (entries[0].isIntersecting && renderedCount < filteredCmdlets.length) renderNextChunk();
            }, { rootMargin: '200px' });
            scrollObserver.observe(sentinel);
        }

        function updateStats() {
            document.getElementById('totalCmdlets').textContent = cmdlets.length;
            document.getElementById('filteredCount').textContent = filteredCmdlets.length;
        }

        function fuzzyScore(query, target) {
            if (!query || !target) return 0;
            var q = query.toLowerCase(), t = target.toLowerCase();
            if (t.includes(q)) return 100 + (q.length / t.length) * 50;
            var qi = 0, score = 0, consecutive = 0, lastIdx = -2;
            for (var ti = 0; ti < t.length && qi < q.length; ti++) {
                if (t[ti] === q[qi]) {
                    score += 1;
                    if (ti === lastIdx + 1) { consecutive++; score += consecutive * 2; } else consecutive = 0;
                    if (ti === 0 || t[ti-1] === '-' || t[ti-1] === ' ' || t[ti-1] === '.') score += 5;
                    lastIdx = ti; qi++;
                }
            }
            return qi === q.length ? score : 0;
        }

        function highlightPowerShell(code) {
            var html = code;
            html = html.replace(/(&#39;[^&#]*?&#39;)/g, '<span class="ps-string">$1</span>');
            html = html.replace(/(&quot;[^&]*?&quot;)/g, '<span class="ps-string">$1</span>');
            html = html.replace(/((?<!&)#[^\n]*)/g, '<span class="ps-comment">$1</span>');
            html = html.replace(/(\$\w+)/g, '<span class="ps-variable">$1</span>');
            html = html.replace(/\b([A-Z][a-z]+-[A-Z]\w+)/g, '<span class="ps-cmdlet">$1</span>');
            html = html.replace(/(\[[A-Z]\w+(?:\.\w+)*(?:\[\])?\])/g, '<span class="ps-type">$1</span>');
            return html;
        }

        var commonParams = new Set(['WhatIf','Confirm','Break','Headers','HttpPipelineAppend','HttpPipelinePrepend','Proxy','ProxyCredential','ProxyUseDefaultCredentials','ResponseHeadersVariable','AdditionalProperties']);
        function parseParameters(syntax) {
            var params = [], paramStr = syntax.substring(syntax.indexOf(' ') + 1);
            var re = /(\[)?-(\w+)(?:\s+<([^>]+)>)?/g, m;
            while ((m = re.exec(paramStr)) !== null) {
                if (commonParams.has(m[2]) || m[2] === 'CommonParameters') continue;
                params.push({ name: m[2], type: m[3] || 'switch', required: !m[1] });
            }
            return params;
        }

        function getLearnUrl(c) {
            if (!c.module) return '';
            return 'https://learn.microsoft.com/powershell/module/' + c.module.toLowerCase() + '/' + c.name.toLowerCase();
        }

        function buildNounMap() {
            nounMap = {};
            cmdlets.forEach(function(c) {
                var idx = c.name.indexOf('-');
                if (idx > 0) { var noun = c.name.substring(idx + 1); if (!nounMap[noun]) nounMap[noun] = []; nounMap[noun].push(c.name); }
            });
        }

        function buildAlphaIndex() {
            var nav = document.getElementById('alphaIndex');
            if (!nav) return;
            var letters = [...new Set(filteredCmdlets.map(c => c.name[0].toUpperCase()))].sort();
            nav.innerHTML = letters.map(l => '<button onclick="scrollToLetter(\'' + l + '\')">' + l + '</button>').join('');
        }
        function scrollToLetter(letter) {
            var idx = filteredCmdlets.findIndex(c => c.name[0].toUpperCase() === letter);
            if (idx < 0) return;
            while (renderedCount <= idx) renderNextChunk();
            var cards = document.querySelectorAll('#cmdletsGrid > div');
            if (cards[idx]) cards[idx].scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function showRecentSearches() {
            var dd = document.getElementById('recentSearches');
            var input = document.getElementById('searchInput');
            if (input.value || recentSearches.length === 0) { dd.style.display = 'none'; return; }
            dd.style.display = 'block';
            dd.innerHTML = recentSearches.map(s => '<button onclick="applyRecentSearch(this.textContent)">' + escapeHtml(s) + '</button>').join('') +
                '<button class="clear-btn" onclick="clearRecentSearches()">Clear History</button>';
        }
        function saveRecentSearch(term) {
            if (!term || term.length < 2) return;
            recentSearches = [term, ...recentSearches.filter(s => s !== term)].slice(0, 8);
            localStorage.setItem('exchRecentSearches', JSON.stringify(recentSearches));
        }
        function applyRecentSearch(term) { document.getElementById('searchInput').value = term; document.getElementById('recentSearches').style.display = 'none'; filterCmdlets(); }
        function clearRecentSearches() { recentSearches = []; localStorage.removeItem('exchRecentSearches'); document.getElementById('recentSearches').style.display = 'none'; }

        function serializeState() {
            var p = new URLSearchParams();
            var q = document.getElementById('searchInput').value; if (q) p.set('q', q);
            var cat = document.getElementById('categoryFilter').value; if (cat) p.set('cat', cat);
            var mod = document.getElementById('moduleFilter').value; if (mod) p.set('mod', mod);
            if (activeVerbs.size > 0) p.set('verbs', [...activeVerbs].join(','));
            if (currentSort !== 'alpha') p.set('sort', currentSort);
            var hash = p.toString();
            history.replaceState(null, '', hash ? '#' + hash : location.pathname + location.search);
        }
        function restoreState() {
            var hash = location.hash.slice(1);
            if (!hash) { filterCmdlets(); return; }
            var p = new URLSearchParams(hash);
            if (p.has('q')) document.getElementById('searchInput').value = p.get('q');
            if (p.has('cat')) document.getElementById('categoryFilter').value = p.get('cat');
            if (p.has('mod')) document.getElementById('moduleFilter').value = p.get('mod');
            if (p.has('verbs')) { activeVerbs = new Set(p.get('verbs').split(',')); refreshVerbButtonStyles(); }
            if (p.has('sort')) { currentSort = p.get('sort'); document.getElementById('sortSelect').value = currentSort; }
            filterCmdlets();
        }

        function refreshVerbButtonStyles() {
            document.querySelectorAll('#verbFilters button').forEach(function(btn) {
                var f = btn.dataset.filter;
                var active = (f === 'all' && activeVerbs.size === 0) || activeVerbs.has(f);
                btn.classList.toggle('verb-tag-active', active);
            });
        }

        function savePreset() {
            var name = prompt('Preset name:');
            if (!name) return;
            savedPresets.push({
                name: name,
                q: document.getElementById('searchInput').value,
                cat: document.getElementById('categoryFilter').value,
                mod: document.getElementById('moduleFilter').value,
                verbs: [...activeVerbs],
                sort: currentSort
            });
            localStorage.setItem('exchSavedPresets', JSON.stringify(savedPresets));
            renderPresets();
        }
        function loadPreset(idx) {
            var p = savedPresets[idx]; if (!p) return;
            document.getElementById('searchInput').value = p.q || '';
            document.getElementById('categoryFilter').value = p.cat || '';
            document.getElementById('moduleFilter').value = p.mod || '';
            activeVerbs = new Set(p.verbs || []);
            currentSort = p.sort || 'alpha';
            document.getElementById('sortSelect').value = currentSort;
            refreshVerbButtonStyles(); filterCmdlets();
        }
        function deletePreset(idx) { savedPresets.splice(idx, 1); localStorage.setItem('exchSavedPresets', JSON.stringify(savedPresets)); renderPresets(); }
        function renderPresets() {
            var el = document.getElementById('presetsList'); if (!el) return;
            el.innerHTML = savedPresets.map((p, i) =>
                '<span class="preset-chip"><button onclick="loadPreset(' + i + ')">' + escapeHtml(p.name) + '</button><button onclick="deletePreset(' + i + ')">&times;</button></span>'
            ).join('');
        }

        function toggleExportMenu() { var m = document.getElementById('exportMenu'); m.style.display = m.style.display === 'block' ? 'none' : 'block'; }
        function toggleInstallHelp() { var m = document.getElementById('installHelp'); m.style.display = m.style.display === 'block' ? 'none' : 'block'; }
        function exportResults(format) {
            document.getElementById('exportMenu').style.display = 'none';
            var content, filename, mime;
            if (format === 'json') {
                content = JSON.stringify(filteredCmdlets.map(c => ({ name: c.name, category: c.category, module: c.module, description: c.description })), null, 2);
                filename = 'cmdlets.json'; mime = 'application/json';
            } else {
                var rows = [['Name','Category','Module','Description']];
                filteredCmdlets.forEach(c => rows.push([c.name, c.category, c.module||'', '"'+c.description.replace(/"/g,'""')+'"']));
                content = rows.map(r => r.map(v => '"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\n');
                filename = 'cmdlets.csv'; mime = 'text/csv';
            }
            var blob = new Blob([content], { type: mime });
            var a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename;
            document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(a.href);
        }

        function copyText(text) {
            if (navigator.clipboard) navigator.clipboard.writeText(text);
            else { var t = document.createElement('textarea'); t.value = text; document.body.appendChild(t); t.select(); document.execCommand('copy'); document.body.removeChild(t); }
        }

        function updateFilterBadge() {
            var count = 0;
            if (activeVerbs.size > 0) count++;
            if (document.getElementById('categoryFilter').value) count++;
            if (document.getElementById('moduleFilter').value) count++;
            var badge = document.getElementById('filterBadge');
            if (count > 0) { badge.textContent = count; badge.classList.add('active'); }
            else { badge.classList.remove('active'); }
        }
        function toggleMobileFilters() { var f = document.getElementById('verbFilters'); var hidden = window.getComputedStyle(f).display === 'none'; f.style.display = hidden ? 'flex' : 'none'; }

        function updateCardFocus() {
            document.querySelectorAll('.card-focused').forEach(el => el.classList.remove('card-focused'));
            var cards = document.querySelectorAll('#cmdletsGrid > .cmdlet-card');
            if (focusedCardIndex >= 0 && focusedCardIndex < cards.length) {
                cards[focusedCardIndex].classList.add('card-focused');
                cards[focusedCardIndex].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        // -- Event listeners --
        document.getElementById('searchInput').addEventListener('input', debounce(filterCmdlets, 150));
        document.getElementById('searchInput').addEventListener('focus', showRecentSearches);
        document.getElementById('searchInput').addEventListener('blur', () => setTimeout(() => { document.getElementById('recentSearches').style.display = 'none'; }, 200));
        document.getElementById('categoryFilter').addEventListener('change', filterCmdlets);
        document.getElementById('moduleFilter').addEventListener('change', filterCmdlets);
        document.getElementById('sortSelect').addEventListener('change', filterCmdlets);

        document.addEventListener('keydown', function(e) {
            if (e.key === '/' && !['INPUT','SELECT','TEXTAREA'].includes(document.activeElement.tagName)) { e.preventDefault(); document.getElementById('searchInput').focus(); return; }
            if (e.key === 'Escape') {
                document.getElementById('searchInput').value = ''; document.getElementById('searchInput').blur();
                document.getElementById('recentSearches').style.display = 'none';
                focusedCardIndex = -1; document.querySelectorAll('.card-focused').forEach(el => el.classList.remove('card-focused'));
                filterCmdlets(); return;
            }
            if (['INPUT','SELECT','TEXTAREA'].includes(document.activeElement.tagName)) return;
            var cards = document.querySelectorAll('#cmdletsGrid > .cmdlet-card');
            if (e.key === 'ArrowDown' || e.key === 'j') { e.preventDefault(); focusedCardIndex = Math.min(focusedCardIndex + 1, cards.length - 1); while (renderedCount <= focusedCardIndex) renderNextChunk(); updateCardFocus(); }
            else if (e.key === 'ArrowUp' || e.key === 'k') { e.preventDefault(); focusedCardIndex = Math.max(focusedCardIndex - 1, 0); updateCardFocus(); }
            else if (e.key === 'Enter' && focusedCardIndex >= 0 && focusedCardIndex < cards.length) {
                e.preventDefault();
                var card = cards[focusedCardIndex];
                card.classList.toggle('card-expanded');
                if (card.classList.contains('card-expanded')) {
                    var name = card.dataset.name, mod = card.dataset.module;
                    if (name && mod) populateCardDetail(card, name, mod);
                } else { var dc = card.querySelector('.card-detail'); if (dc) { dc.innerHTML = ''; delete dc.dataset.loaded; } }
            }
        });

        document.getElementById('cmdletsGrid').addEventListener('click', function(e) {
            var copyBtn = e.target.closest('[data-copy-syntax], [data-copy-ex]');
            if (copyBtn) {
                e.stopPropagation();
                var container = copyBtn.closest('.detail-syntax') || copyBtn.closest('.example-block');
                if (container) {
                    var text = container.textContent;
                    copyText(text);
                    var svg = copyBtn.querySelector('svg');
                    if (svg) { var orig = svg.innerHTML; svg.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>'; setTimeout(() => { svg.innerHTML = orig; }, 1500); }
                }
                return;
            }
            if (e.target.closest('a, button, details, summary, select')) return;
            var card = e.target.closest('.cmdlet-card');
            if (!card) return;
            card.classList.toggle('card-expanded');
            if (card.classList.contains('card-expanded')) {
                var name = card.dataset.name, mod = card.dataset.module;
                if (name && mod) populateCardDetail(card, name, mod);
            } else { var dc = card.querySelector('.card-detail'); if (dc) { dc.innerHTML = ''; delete dc.dataset.loaded; } }
        });

        window.addEventListener('scroll', function() {
            var btn = document.getElementById('backToTop');
            btn.classList.toggle('visible', window.scrollY > 400);
        }, { passive: true });

        document.addEventListener('click', function(e) { if (!e.target.closest('#exportWrap')) document.getElementById('exportMenu').style.display = 'none'; if (!e.target.closest('#installHelpWrap')) document.getElementById('installHelp').style.display = 'none'; });
        window.addEventListener('popstate', restoreState);

        // -- Onboarding --
        var onboardingTips = [
            { target: '#searchInput', text: 'Search by cmdlet name, description, or category. Supports fuzzy matching.' },
            { target: '#verbFilters', text: 'Click verb buttons to filter by action type. Select multiple verbs at once.' },
            { target: '#categoryFilter', text: 'Use dropdowns to filter by category, module, or change sort order.' },
            { target: '#cmdletsGrid', text: 'Click any card to expand it and load full details (syntax, examples, related cmdlets).' }
        ];
        function showNextTip() {
            if (onboardingStep >= onboardingTips.length) { dismissOnboarding(); return; }
            var tip = onboardingTips[onboardingStep];
            var target = document.querySelector(tip.target);
            if (!target) { onboardingStep++; showNextTip(); return; }
            var overlay = document.getElementById('onboardingOverlay');
            var tipEl = document.getElementById('onboardingTip');
            overlay.style.display = 'block';
            document.getElementById('tipText').textContent = tip.text;
            var rect = target.getBoundingClientRect();
            tipEl.style.top = Math.min(rect.bottom + 8, window.innerHeight - 150) + 'px';
            tipEl.style.left = Math.max(8, Math.min(rect.left, window.innerWidth - 320)) + 'px';
            onboardingStep++;
        }
        function dismissOnboarding() {
            hasSeenOnboarding = true;
            localStorage.setItem('exchHasSeenOnboarding', 'true');
            document.getElementById('onboardingOverlay').style.display = 'none';
        }

        // Dismiss onboarding on scroll
        window.addEventListener('scroll', function() {
            if (!hasSeenOnboarding && document.getElementById('onboardingOverlay').style.display !== 'none') dismissOnboarding();
        }, { passive: true, once: true });

        function toggleAppearance() {
            var isLight = document.documentElement.classList.toggle('light');
            localStorage.setItem('exchAppearance', isLight ? 'light' : 'dark');
            updateAppearanceIcons();
        }

        function updateAppearanceIcons() {
            var isLight = document.documentElement.classList.contains('light');
            document.getElementById('iconSun').style.display = isLight ? 'none' : 'block';
            document.getElementById('iconMoon').style.display = isLight ? 'block' : 'none';
        }

        function switchTheme(file) {
            if (file && file !== location.pathname.split('/').pop()) {
                location.href = file + location.hash;
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadCmdlets();
            updateAppearanceIcons();
        });
    </script>
</body>
</html>
